<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Comparateur Applications - L1/L2/L3</title>
  <link rel="stylesheet" href="comparator-styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Application Assessment</h1>
      <p>Comparez les Business Capabilities de vos applications</p>
      <div class="detail-level-container" style="margin-bottom:1em;">
        <div id="selected-apps-info" style="margin-bottom:0.5em; font-style:italic; color:#666;"></div>
        <label style="margin-left:2em;">Application 1 <select id="app1" class="search-input"></select></label>
        <label style="margin-left:1em;">Application 2 <select id="app2" class="search-input"></select></label>
      </div>
    </div>
    <div class="comparison-area">
      <div id="result"></div>
    </div>
  </div>
  <script>
  let data, bc, level=1, l1Tab=null;
    let l2Tab=null;
    const app1 = document.getElementById('app1');
    const app2 = document.getElementById('app2');

  let bcdefs = {};
  fetch('bc-definitions.json').then(r=>r.json()).then(d=>{ bcdefs=d; maybeInit(); });
  fetch('app-capabilities-unified.json').then(r=>r.json()).then(d=>{ data=d; maybeInit(); });
  fetch('bc-mapping.json').then(r=>r.json()).then(d=>{ bc=d._hierarchy; maybeInit(); });

  function maybeInit() {
    if (data && bc && bcdefs && Object.keys(bcdefs).length > 0) fillSelects();
  }
    function fillSelects() {
      let apps=Object.keys(data);
      app1.innerHTML = app2.innerHTML = apps.map(a=>`<option>${a}</option>`).join('');
      
      // R√©cup√©rer les applications s√©lectionn√©es depuis localStorage
      const savedApps = localStorage.getItem('comparatorApps');
      const infoDiv = document.getElementById('selected-apps-info');
      
      if (savedApps) {
        try {
          const comparatorApps = JSON.parse(savedApps);
          console.log('üìã Applications r√©cup√©r√©es du comparateur:', comparatorApps);
          
          // Pr√©s√©lectionner les applications si elles existent
          if (comparatorApps.length >= 1) {
            app1.value = comparatorApps[0].name;
          }
          if (comparatorApps.length >= 2) {
            app2.value = comparatorApps[1].name;
          }
        } catch (e) {
          console.error('Erreur lors de la r√©cup√©ration des applications du comparateur:', e);
          infoDiv.innerHTML = '';
          // Valeurs par d√©faut
          if (!app1.value) app1.value = apps[0];
          if (!app2.value) app2.value = apps[1] || apps[0];
        }
      } else {
        // Aucune application sauvegard√©e
        infoDiv.innerHTML = '';
        if (!app1.value) app1.value = apps[0];
        if (!app2.value) app2.value = apps[1] || apps[0];
      }
      
      app1.onchange=app2.onchange=show;
      show();
    }
    function getDef(code, level) {
      if(!bcdefs) return code;
      if(level===1 && bcdefs.L1 && bcdefs.L1[code]) return bcdefs.L1[code];
      if(level===2 && bcdefs.L2 && bcdefs.L2[code]) return bcdefs.L2[code];
      if(level===3 && bcdefs.L3 && bcdefs.L3[code]) return bcdefs.L3[code];
      if(level===4 && bcdefs.L4 && bcdefs.L4[code]) return bcdefs.L4[code];
      return code;
    }
    
    // Fonction pour d√©terminer la classe de couleur bas√©e sur le pourcentage
    function getColorClass(percentage) {
      if (percentage < 20) return 'coverage coverage-red';
      if (percentage < 50) return 'coverage coverage-orange';
      if (percentage < 80) return 'coverage coverage-black';
      return 'coverage coverage-green';
    }
    
    function show() {
  if(!data||!bc||!bcdefs) return;
      let a1=data[app1.value], a2=data[app2.value];
        let html='<div class="comparison-table"><div class="table-header">';
        if(l1Tab){
        html += `<h3>${getDef(l1Tab,1)}</h3>`;
        } else {
          html += '<h3>Assessment Transport Applications</h3>';
        }
        html+='</div>';
      html+='<table class="capability-table"><thead><tr><th>Business Capabilities</th><th>'+app1.value+'</th><th>'+app2.value+'</th></tr></thead><tbody>';
        // Onglets L1
        let l1s = Object.keys(bc);
        if(l1Tab && l2Tab){
  html += `<button id="btn-back-l2" class="btn btn-secondary" style="margin-bottom:1em;">&larr; Retour</button>`;
  // Boutons horizontaux L2
  let l2s = Object.keys(bc[l1Tab]);
  let l2Buttons = l2s.map(l2 => `<button class="btn l2btn${l2Tab===l2?' selected':''}" data-l2="${l2}" style="margin-right:0.5em;">${getDef(l2,2)}</button>`).join('');
  html += `<div id="l2-buttons" style="margin-bottom:1em;">${l2Buttons}</div>`;
        // Tableau L3/L4 pour la L2 s√©lectionn√©e
        Object.keys(bc[l1Tab][l2Tab]).forEach(l3=>{
          const l3Def = getDef(l3,3);
          html+=`<tr class="l3-row"><td><b>${l3Def}</b></td><td class="tick app-column">${a1.l3 && a1.l3.includes(l3)?'‚úì':''}</td><td class="tick app-column">${a2.l3 && a2.l3.includes(l3)?'‚úì':''}</td></tr>`;
          if(Array.isArray(bc[l1Tab][l2Tab][l3])){
            bc[l1Tab][l2Tab][l3].forEach(l4=>{
              const l4Def = getDef(l4,4);
              html+=`<tr class="l4-row"><td style='padding-left:2em;'>${l4Def}</td><td class="tick app-column">${a1.l4 && a1.l4.includes(l4)?'‚úì':''}</td><td class="tick app-column">${a2.l4 && a2.l4.includes(l4)?'‚úì':''}</td></tr>`;
            });
          }
        });
        } else if(l1Tab){
          html += `<button id="btn-back-l1" class="btn btn-secondary" style="margin-bottom:1em;">&larr; Retour</button>`;
          // Boutons horizontaux L1
          let l1Buttons = Object.keys(bc).map(l1 => `<button class="btn l1btn${l1Tab===l1?' selected':''}" data-l1="${l1}" style="margin-right:0.5em;">${getDef(l1,1)}</button>`).join('');
          html += `<div id="l1-buttons" style="margin-bottom:1em;">${l1Buttons}</div>`;
          Object.keys(bc[l1Tab]).forEach(l2=>{
            const l2Def = getDef(l2,2);
            
            // Calculer le nombre de L3 filles qui ont plus de 20% de couverture L4 (m√™me r√©f√©rence que L1 niveau 1)
            const l3Children = Object.keys(bc[l1Tab][l2]);
            const totalL3 = l3Children.length;
            let a1L3Above20 = 0;
            let a2L3Above20 = 0;
            
            l3Children.forEach(l3 => {
              const l4s = bc[l1Tab][l2][l3] || [];
              const l4Count = l4s.length;
              const a1L4Count = l4s.filter(l4 => a1.l4 && a1.l4.includes(l4)).length;
              const a2L4Count = l4s.filter(l4 => a2.l4 && a2.l4.includes(l4)).length;
              const a1Percentage = l4Count > 0 ? Math.round((a1L4Count / l4Count) * 100) : 0;
              const a2Percentage = l4Count > 0 ? Math.round((a2L4Count / l4Count) * 100) : 0;
              
              if (a1Percentage >= 20) a1L3Above20++;
              if (a2Percentage >= 20) a2L3Above20++;
            });
            
            html+=`<tr class="l2-row l2-clickable"><td><b>${l2Def}</b></td><td class="coverage app-column">${a1L3Above20}/${totalL3}</td><td class="coverage app-column">${a2L3Above20}/${totalL3}</td></tr>`;
            Object.keys(bc[l1Tab][l2]).forEach(l3=>{
              const l3Def = getDef(l3,3);
              // Calculer le pourcentage de L4 filles couvertes pour cette L3
              const l4s = bc[l1Tab][l2][l3] || [];
              const l4Count = l4s.length;
              const a1L4Count = l4s.filter(l4 => a1.l4 && a1.l4.includes(l4)).length;
              const a2L4Count = l4s.filter(l4 => a2.l4 && a2.l4.includes(l4)).length;
              const a1Percentage = l4Count > 0 ? Math.round((a1L4Count / l4Count) * 100) : 0;
              const a2Percentage = l4Count > 0 ? Math.round((a2L4Count / l4Count) * 100) : 0;
              const a1ColorClass = getColorClass(a1Percentage);
              const a2ColorClass = getColorClass(a2Percentage);
              html+=`<tr class="l3-row"><td style='padding-left:2em;'>${l3Def}</td><td class="tick app-column ${a1ColorClass}">${a1Percentage}%</td><td class="tick app-column ${a2ColorClass}">${a2Percentage}%</td></tr>`;
            });
          });
        } else {
          // Vue niveau 1 : tableau global sans boutons
          Object.keys(bc).forEach(l1=>{
            const l1Def = getDef(l1,1);
            
            // Calculer le pourcentage de L2 filles qui d√©passent 20% de couverture
            const l2Keys = Object.keys(bc[l1]);
            const totalL2 = l2Keys.length;
            let app1L2Above20 = 0;
            let app2L2Above20 = 0;
            
            l2Keys.forEach(l2 => {
              const l3Children = Object.keys(bc[l1][l2]);
              const totalL3 = l3Children.length;
              
              if (totalL3 > 0) {
                const app1CoveredL3 = l3Children.filter(l3 => a1.l3 && a1.l3.includes(l3)).length;
                const app2CoveredL3 = l3Children.filter(l3 => a2.l3 && a2.l3.includes(l3)).length;
                
                const app1PercentL2 = (app1CoveredL3 / totalL3) * 100;
                const app2PercentL2 = (app2CoveredL3 / totalL3) * 100;
                
                if (app1PercentL2 >= 20) app1L2Above20++;
                if (app2PercentL2 >= 20) app2L2Above20++;
              }
            });
            
            // Afficher les fractions au lieu des pourcentages pour les L1
            html+=`<tr class="l1-row"><td><b>${l1Def}</b></td><td class="coverage app-column">${app1L2Above20}/${totalL2}</td><td class="coverage app-column">${app2L2Above20}/${totalL2}</td></tr>`;
            Object.keys(bc[l1]).forEach(l2=>{
              const l2Def = getDef(l2,2);
              
              // Calculer le nombre de L3 filles de cette L2
              const l3Children = Object.keys(bc[l1][l2]);
              const totalL3 = l3Children.length;
              
              // Calculer combien de L3 sont couvertes par chaque application
              const app1CoveredL3 = l3Children.filter(l3 => a1.l3 && a1.l3.includes(l3)).length;
              const app2CoveredL3 = l3Children.filter(l3 => a2.l3 && a2.l3.includes(l3)).length;
              
              // Calculer les pourcentages arrondis
              const app1PercentL2 = totalL3 > 0 ? Math.round((app1CoveredL3 / totalL3) * 100) : 0;
              const app2PercentL2 = totalL3 > 0 ? Math.round((app2CoveredL3 / totalL3) * 100) : 0;
              
              // D√©terminer les classes de couleur
              const app1ColorClass = getColorClass(app1PercentL2);
              const app2ColorClass = getColorClass(app2PercentL2);
              
              html+=`<tr class="l2-row l2-clickable" data-l1="${l1}" data-l2="${l2}"><td>${l2Def}</td><td class="${app1ColorClass} app-column">${app1PercentL2}%</td><td class="${app2ColorClass} app-column">${app2PercentL2}%</td></tr>`;
            });
          });
        }
      html+='</tbody></table></div>';
      document.getElementById('result').innerHTML=html;
      // Ajoute les handlers pour les boutons et le bouton retour
      if(l1Tab && l2Tab){
        let btnBack = document.getElementById('btn-back-l2');
        if(btnBack) btnBack.onclick = function(){ l2Tab = null; show(); };
        Array.from(document.querySelectorAll('#l2-buttons button')).forEach(btn => {
          btn.onclick = function() {
            l2Tab = this.getAttribute('data-l2');
            show();
          };
        });
      } else if(l1Tab){
        let btnBack = document.getElementById('btn-back-l1');
        if(btnBack) btnBack.onclick = function(){ l1Tab = null; show(); };
        Array.from(document.querySelectorAll('#l1-buttons button')).forEach(btn => {
          btn.onclick = function() {
            l1Tab = this.getAttribute('data-l1');
            l2Tab = null;
            show();
          };
        });
        // L2 cliquables
        Array.from(document.querySelectorAll('.l2-row.l2-clickable')).forEach((row, idx) => {
          row.style.cursor = 'pointer';
          row.onclick = function() {
            const l2s = Object.keys(bc[l1Tab]);
            l2Tab = l2s[idx];
            show();
          };
        });
      } else {
        // En niveau 1, chaque L1 est cliquable (ligne du tableau)
        Array.from(document.querySelectorAll('.l1-row')).forEach(row => {
          row.style.cursor = 'pointer';
          row.onclick = function() {
            const idx = Array.from(document.querySelectorAll('.l1-row')).indexOf(this);
            l1Tab = Object.keys(bc)[idx];
            l2Tab = null;
            show();
          };
        });
        // L2 cliquables
        Array.from(document.querySelectorAll('.l2-row.l2-clickable')).forEach(row => {
          row.style.cursor = 'pointer';
          row.onclick = function() {
            l1Tab = this.getAttribute('data-l1');
            l2Tab = this.getAttribute('data-l2');
            show();
          };
        });
      }
    }
  </script>
</body>
</html>
